# Instalar y configurar el sistema de detección de intrusos Snort 3 en Ubuntu

## Requisitos previos

- Un servidor con Ubuntu
- Se configura una contraseña raíz en el servidor.

## Instalar las dependencias requeridas

Antes de comenzar, deberá instalar algunas dependencias en su servidor. Puede instalarlos todos ejecutando el siguiente comando:

```bash
$ apt install build-essential libpcap-dev libpcre3-dev libnet1-dev zlib1g-dev luajit hwloc libdnet-dev libdumbnet-dev bison flex liblzma-dev openssl libssl-dev pkg-config libhwloc-dev cmake cpputest libsqlite3-dev uuid-dev libcmocka-dev libnetfilter-queue-dev libmnl-dev autotools-dev libluajit-5.1-dev libunwind-dev libfl-dev -y
```

Una vez que todas las dependencias estén instaladas, se puede continuar con el siguiente paso.

## Instalar Snort DAQ

A continuación, deberá instalar la biblioteca de adquisición de datos en su sistema. De forma predeterminada, no está disponible en el repositorio predeterminado de Ubuntu. Por lo tanto, deberá compilarlo desde la fuente.

Primero, descargue Snort DAQ de Git con el siguiente comando:

```bash
$ git clone https://github.com/snort3/libdaq.git
```

Una vez que se complete la descarga, navegue hasta el directorio descargado y configúrelo con el siguiente comando:

```bash
$ cd libdaq
$ ./bootstrap
$ ./configure
```

Debería ver el siguiente resultado:

```bash
cc:         gcc
 
cppflags:
am_cppflags: -fvisibility=hidden -Wall -Wmissing-declarations -Wpointer-arith -Wcast-align -Wcast-qual -Wformat -Wformat-nonliteral -Wformat-security -Wundef -Wwrite-strings -Wextra -Wsign-compare -Wno-unused-parameter -fno-strict-aliasing -fdiagnostics-show-option

cflags:     -g -O2
am_cflags:   -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition -Wnested-externs

ldflags:
am_ldflags:

libs:
code_coverage_enabled:  no
code_coverage_cppflags:
code_coverage_cflags:
code_coverage_ldflags:
Build AFPacket DAQ module.. : yes
Build BPF DAQ module....... : yes
Build Divert DAQ module.... : no
Build Dump DAQ module...... : yes
Build FST DAQ module....... : yes
Build netmap DAQ module.... : no
Build NFQ DAQ module....... : yes
Build PCAP DAQ module...... : yes
Build Savefile DAQ module.. : yes
Build Trace DAQ module..... : yes
Build GWLB DAQ module...... : yes
```

A continuación, instálelo con el siguiente comando:

```bash
$ Make
$ make install
```

## Instalar Gperftools

Primero, descargue la última versión de Gperftools con el siguiente comando:

```bash
$ cd
$ wget https://github.com/gperftools/gperftools/releases/download/gperftools-2.9.1/gperftools-2.9.1.tar.gz
```

Una vez que se complete la descarga, extraiga el archivo descargado con el siguiente comando:

```bash
$ tar xzf gperftools-2.9.1.tar.gz
```

A continuación, navegue hasta el directorio descargado y compílelo con el siguiente comando:

```bash
$ cd gperftools-2.9.1/
$ ./configure
```

A continuación, instálelo con el siguiente comando:

```bash
$ Make
$ make install
```

## Instalar Snort

A continuación, descarga la última versión de Snort con el siguiente comando:

```bash
$ cd
$ wget https://github.com/snort3/snort3/archive/refs/tags/3.1.43.0.tar.gz
```

A continuación, extraiga el archivo descargado con el siguiente comando:

```bash
$ tar -xvzf 3.1.43.0.tar.gz
```

A continuación, navegue hasta el directorio extraído y configúrelo con el siguiente comando:

```bash
$ cd snort3-3.1.43.0
$ ./configure_cmake.sh --prefix=/usr/local --enable-tcmalloc
```

Obtendrá el siguiente resultado:

```bash
snort version 3.1.43.0

Install options:
  prefix:  /usr/local
  includes:   /usr/local/include/snort
  plugins: /usr/local/lib/snort

Compiler options:
  CC:          /usr/bin/cc
  CXX:         /usr/bin/c++
  CFLAGS:         -fvisibility=hidden   -DNDEBUG -g -ggdb  -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free  -O2 -g -DNDEBUG
  CXXFLAGS:       -fvisibility=hidden   -DNDEBUG -g -ggdb  -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free  -O2 -g -DNDEBUG
  EXE_LDFLAGS:     
  MODULE_LDFLAGS:  

Feature options:
  DAQ Modules: Static (afpacket;bpf;dump;fst;gwlb;nfq;pcap;savefile;trace)
  libatomic:   System-provided
  Hyperscan:   OFF
  ICONV:       ON
  Libunwind:   ON
  LZMA:        ON
  RPC DB:      Built-in
  SafeC:       OFF
  TCMalloc:    ON
  JEMalloc:    OFF
  UUID:           ON
 -------------------------------------------------------

-- Configuring done
 -- Generating done
 -- Build files have been written to: /root/snort3-3.1.43.0/build
```

A continuación, cambie el directorio al directorio de compilación e instale Snort con el siguiente comando:

```bash
$ cd build
$ make
$ make install
$ ldconfig
```

Ahora puede verificar la versión de Snort usando el siguiente comando:

```bash
snort -V
```

Obtendrá el siguiente resultado:

```bash
   ,,_     -*> Snort++ <*-
   o"  )~   Version 3.1.43.0
    ''''    By Martin Roesch & The Snort Team
     http://snort.org/contact#team
     Copyright (C) 2014-2024 Cisco and/or its affiliates. All rights reserved.
     Copyright (C) 1998-2013 Sourcefire, Inc., et al.
     Using DAQ version 3.0.9
     Using LuaJIT version 2.1.0-beta3
     Using OpenSSL 3.0.2 15 Mar 2022
     Using libpcap version 1.10.1 (with TPACKET_V3)
     Using PCRE version 8.39 2016-06-14
     Using ZLIB version 1.2.11
     Using LZMA version 5.2.5
```

## Configurar Snort

Primero, deberá configurar su interfaz de red en modo promiscuo para que pueda ver todo el tráfico de red que se le envía.  
Puede configurarlo usando el siguiente comando:

```bash
$ ip link set dev eth0 promisc on
```

Ahora puede verificarlo con el siguiente comando:

```bash
$ ip add sh eth0
```

A continuación, también deberá deshabilitar la descarga de interfaz.  
Primero, verifique si esta característica está habilitada o no usando el siguiente comando:

```bash
$ ethtool -k eth0 | grep receive-offload
```

Obtendrá el siguiente resultado:

```bash
generic-receive-offload: on
 large-receive-offload: off [fixed]
```

Ahora puede deshabilitarlo usando el siguiente comando:

```bash
$ ethtool -K eth0 gro off lro off
```

## Crear un archivo de servicio Systemd para Snort NIC

A continuación, deberá crear un archivo de servicio systemd para Snort NIC.

```bash
$ nano /etc/systemd/system/snort3-nic.service
```
 
Agregue las siguientes líneas:

```txt
[Unit]
 Description=Set Snort 3 NIC in promiscuous mode and Disable GRO, LRO on boot
 After=network.target

[Service]
 Type=oneshot
 ExecStart=/usr/sbin/ip link set dev eth0 promisc on
 ExecStart=/usr/sbin/ethtool -K eth0 gro off lro off
 TimeoutStartSec=0
 RemainAfterExit=yes

[Install]
 WantedBy=default.target
```

Guarde y cierre el archivo, luego vuelva a cargar el demonio systemd para aplicar los cambios:

```bash
$ systemctl daemon-reload
```

A continuación, inicie y habilite Snort con el siguiente comando:

```bash
$ systemctl start snort3-nic.service
$ systemctl enable snort3-nic.service
```

Puede verificar el estado del Snort con el siguiente comando:

```bash
$ systemctl status snort3-nic.service
```

Obtendrá el siguiente resultado:

```bash
? snort3-nic.service - Set Snort 3 NIC in promiscuous mode and Disable GRO, LRO on boot
   Loaded: loaded (/etc/systemd/system/snort3-nic.service; disabled; vendor preset: enabled)
   Active: active (exited) since Tue 2022-10-11 16:24:15 UTC; 6s ago
  Process: 95745 ExecStart=/usr/sbin/ip link set dev eth0 promisc on (code=exited, status=0/SUCCESS)
  Process: 95746 ExecStart=/usr/sbin/ethtool -K eth0 gro off lro off (code=exited, status=0/SUCCESS)
    Main PID: 95746 (code=exited, status=0/SUCCESS)
      CPU: 11ms

Oct 11 16:24:15 ubuntu2204 systemd[1]: Starting Set Snort 3 NIC in promiscuous mode and Disable GRO, LRO on boot...
 Oct 11 16:24:15 ubuntu2204 systemd[1]: Finished Set Snort 3 NIC in promiscuous mode and Disable GRO, LRO on boot.
```
 
## Instalar reglas de Snort

Las reglas son muy importantes para el motor de detección de intrusos de Snorts. Primero, cree un directorio para almacenar todas las reglas:

```bash
mkdir /usr/local/etc/rules
```

A continuación, descargue las reglas de la comunidad con el siguiente comando:

```bash
wget -qO- https://www.snort.org/downloads/community/snort3-community-rules.tar.gz | tar xz -C /usr/local/etc/rules/
```

A continuación, edite el archivo de configuración principal de Snort:

```bash
nano /usr/local/etc/snort/snort.lua
```
 
Defina su red como se muestra a continuación:

```txt
HOME_NET = '192.168.56.124/32'
 EXTERNAL_NET = '!$HOME_NET'
```

A continuación, define la ruta de tus reglas de Snort:

```txt
ips =
 {
  -- use this to enable decoder and inspector alerts
  --enable_builtin_rules = true,

-- use include for rules files; be sure to set your path
  -- note that rules files can include other rules files
  -- (see also related path vars at the top of snort_defaults.lua)

variables = default_variables,
  rules = [[
  include /usr/local/etc/rules/snort3-community-rules/snort3-community.rules
  ]]

}
```

Guarde y cierre el archivo cuando haya terminado.

## Instalar Snort OpenAppID

OpenAppID es un complemento que permite a Snort detectar varias aplicaciones, Facebook, Netflix, Twitter y Reddit, utilizadas en la red.
Puedes descargarlo con el siguiente comando:

```bash
$ cd
$ wget https://www.snort.org/downloads/openappid/26425 -O OpenAppId-26425.tgz
```
 
Una vez que se complete la descarga, extraiga el archivo descargado con el siguiente comando:

```bash
$ tar -xzvf OpenAppId-26425.tgz
```

A continuación, copie el archivo binario OpenAppID en el directorio del sistema:
 
```bash
$ cp -R odp /usr/local/lib/
```

A continuación, edite el archivo de configuración de Snort y defina su ubicación de OpenAppID:

```bash
$ nano /usr/local/etc/snort/snort.lua
```

Cambia las siguientes líneas:

```txt
appid =
 {
  app_detector_dir = '/usr/local/lib',
  log_stats = true,

}
```

Guarde y cierre el archivo, luego cree un directorio de registro de Snort:
 
```bash
$ mkdir /var/log/snort
```

Finalmente, verifique el archivo de configuración de Snort con el siguiente comando:

```bash
$ snort -c /usr/local/etc/snort/snort.lua
```
 
Si todo está bien, obtendrá el siguiente resultado:

```txt
--------------------------------------------------
 fast pattern groups
                    src: 59
                    dst: 158
                    any: 4
              to_server: 56
              to_client: 39
 --------------------------------------------------
 search engine
              instances: 316
               patterns: 10282
          pattern chars: 166369
             num states: 112212
       num match states: 9885
           memory scale: MB
           total memory: 3.42574
         pattern memory: 0.550588
      match list memory: 1.25256
      transition memory: 1.58402
      fast pattern only: 6822
 --------------------------------------------------
 pcap DAQ configured to passive.

Snort successfully validated the configuration (with 0 warnings).
 o")~   Snort exiting
 ```

## Crear reglas personalizadas de Snort

También puede crear sus propias reglas personalizadas según sus requisitos. Vamos a crear reglas personalizadas para la solicitud ICMP entrante:

```bash
$ nano /usr/local/etc/rules/local.rules
```

Agregue la siguiente línea:

```bash
$ alert icmp any any -> $HOME_NET any (msg:"ICMP connection test"; sid:1000001; rev:1;)
```

A continuación, verifique las reglas con el siguiente comando:

```bash
$ snort -c /usr/local/etc/snort/snort.lua -R /usr/local/etc/rules/local.rules
```

Obtendrá el siguiente resultado:

```txt
search engine
              instances: 316
               patterns: 10282
          pattern chars: 166369
             num states: 112212
       num match states: 9885
           memory scale: MB
           total memory: 3.42574
         pattern memory: 0.550588
      match list memory: 1.25256
      transition memory: 1.58402
      fast pattern only: 6822
 --------------------------------------------------
 pcap DAQ configured to passive.

Snort successfully validated the configuration (with 0 warnings).
 o")~   Snort exiting
```

A continuación, ejecute el siguiente comando para iniciar Snort en su interfaz de red usando sus reglas personalizadas:

```bash
$ snort -c /usr/local/etc/snort/snort.lua -R /usr/local/etc/rules/local.rules -i eth0 -A alert_fast -s 65535 -k none
```

A continuación, abra otra interfaz de terminal y haga ping a su servidor. Debería ver el error ICMP en el primer terminal:

```bash
10/11-16:45:23.848071 [**] [1:1000001:1] "ICMP connection test" [**] [Priority: 0] [AppID: ICMP] {ICMP} 157.32.34.228 -> 209.23.11.18
 10/11-16:45:23.848071 [**] [1:384:8] "PROTOCOL-ICMP PING" [**] [Classification: Misc activity] [Priority: 3] [AppID: ICMP] {ICMP} 157.32.34.228 -> 209.23.11.18
 10/11-16:45:24.323038 [**] [1:366:11] "PROTOCOL-ICMP PING Unix" [**] [Classification: Misc activity] [Priority: 3] [AppID: ICMP] {ICMP} 157.32.34.228 -> 209.23.11.18
 10/11-16:45:24.323038 [**] [1:1000001:1] "ICMP connection test" [**] [Priority: 0] [AppID: ICMP] {ICMP} 157.32.34.228 -> 209.23.11.18
 10/11-16:45:24.323038 [**] [1:384:8] "PROTOCOL-ICMP PING" [**] [Classification: Misc activity] [Priority: 3] [AppID: ICMP] {ICMP} 157.32.34.228 -> 209.23.11.18
 ^C** caught int signal
 == stopping
 10/11-16:45:25.353007 [**] [1:366:11] "PROTOCOL-ICMP PING Unix" [**] [Classification: Misc activity] [Priority: 3] [AppID: ICMP] {ICMP} 157.32.34.228 -> 209.23.11.18
 10/11-16:45:25.353007 [**] [1:1000001:1] "ICMP connection test" [**] [Priority: 0] [AppID: ICMP] {ICMP} 157.32.34.228 -> 209.23.11.18
 10/11-16:45:25.353007 [**] [1:384:8] "PROTOCOL-ICMP PING" [**] [Classification: Misc activity] [Priority: 3] [AppID: ICMP] {ICMP} 157.32.34.228 -> 209.23.11.18
```

## Crear un archivo de servicio de Systemd para Snort

A continuación, cree un archivo de servicio systemd para administrar el Snort a través de systemd.

```bash
$ nano /etc/systemd/system/snort3.service
```

Agregue las siguientes configuraciones:
 
```txt
[Unit]
 Description=Snort Daemon
 After=syslog.target network.target

[Service]
 Type=simple
 ExecStart=/usr/local/bin/snort -c /usr/local/etc/snort/snort.lua -s 65535 -k none -l /var/log/snort -D -i eth0 -m 0x1b -u root -g root
 ExecStop=/bin/kill -9 $MAINPID

[Install]
 WantedBy=multi-user.target
```

Guarde y cierre el archivo, luego vuelva a cargar el demonio systemd con el siguiente comando:

```bash
$ systemctl daemon-reload
```

A continuación, inicie y habilite el servicio Snort con el siguiente comando:

```bash
$ systemctl enable --now snort3
```

Ahora puede verificar el estado del Snort usando el siguiente comando:

```bash
$ systemctl status snort3
```

Obtendrá el siguiente resultado:

```txt
? snort3.service - Snort Daemon
   Loaded: loaded (/etc/systemd/system/snort3.service; enabled; vendor preset: enabled)
   Active: active (running) since Tue 2022-10-11 16:48:28 UTC; 17s ago
    Main PID: 95898 (snort)
    Tasks: 2 (limit: 4579)
   Memory: 233.6M
      CPU: 2.007s
   CGroup: /system.slice/snort3.service
           ??95898 /usr/local/bin/snort -c /usr/local/etc/snort/snort.lua -s 65535 -k none -l /var/log/snort -D -i eth0 -m 0x1b -u root -g >

Oct 11 16:48:29 ubuntu2204 snort[95898]:       num match states: 9885
 Oct 11 16:48:29 ubuntu2204 snort[95898]:           memory scale: MB
 Oct 11 16:48:29 ubuntu2204 snort[95898]:           total memory: 3.42574
 Oct 11 16:48:29 ubuntu2204 snort[95898]:         pattern memory: 0.550588
 Oct 11 16:48:29 ubuntu2204 snort[95898]:         match list memory: 1.25256
 Oct 11 16:48:29 ubuntu2204 snort[95898]:         transition memory: 1.58402
 Oct 11 16:48:29 ubuntu2204 snort[95898]:         fast pattern only: 6822
 Oct 11 16:48:29 ubuntu2204 snort[95898]: --------------------------------------------------
 Oct 11 16:48:29 ubuntu2204 snort[95898]: pcap DAQ configured to passive.
 Oct 11 16:48:29 ubuntu2204 snort[95898]: Commencing packet processing
```

## Conclusión

¡Felicidades! ha instalado y configurado correctamente Snort 3 en Ubuntu. Ahora puede implementar Snort en su organización y protegerla de los ataques DDoS. No dude en preguntarme si tiene alguna pregunta.

